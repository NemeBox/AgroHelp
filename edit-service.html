<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroHelp | Edit Service</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .auth-section {
            padding: 120px 20px 80px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <header id="navbar">
        <div class="container nav-container">
            <div class="logo">
                <span class="logo-text">AgroHelp</span>
            </div>
            <nav class="desktop-nav">
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="service.html">Services</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="nav-actions" id="navActions">
                <div id="authButtons" style="display: none;">
                    <a href="auth_cus.html" class="cta-btn">Sign In</a>
                </div>
                <div id="loggedInInfo" style="display: flex; align-items: center; gap: 10px;">
                    <div class="profile-menu-container">
                        <img id="profilePic" class="profile-pic-circle" alt="User Profile">
                        <div id="profileDropdownContent" class="profile-dropdown-content">
                            <a href="#" class="cta-btn logout-btn">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="auth-section">
        <div class="auth-container" id="service-form-container">
            <div class="auth-visual">
                <div class="visual-content">
                    <div class="logo-text">AgroHelp</div>
                    <h1>Refine Your Offering.<br><span>Update Your Service.</span></h1>
                </div>
            </div>
            <div class="auth-form-box">
                <h2 id="formTitle">Edit Service Details</h2>
                <form id="edit-service-form">
                    <div class="input-group">
                        <i class="fa-solid fa-tag"></i>
                        <input type="text" id="serviceName" name="name" placeholder="Service/Product Name" required>
                    </div>
                    <div class="input-group">
                        <i class="fa-solid fa-layer-group"></i>
                        <select id="serviceCategory" name="category" required>
                            <option value="" disabled>Select a Category</option>
                            <option value="Tool">Tool</option>
                            <option value="Fertilizer">Fertilizer</option>
                            <option value="Consultancy">Consultancy</option>
                            <option value="Soil Testing">Soil Testing</option>
                            <option value="Heavy Machinery">Heavy Machinery</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <i class="fa-solid fa-indian-rupee-sign"></i>
                        <input type="number" id="servicePrice" name="price" placeholder="Price (e.g., 2500.00)" required min="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <i class="fa-solid fa-boxes-stacked"></i>
                        <input type="number" id="serviceStock" name="stock" placeholder="Stock/Availability (e.g., 10)" required min="0">
                    </div>
                    <div class="input-group">
                        <i class="fa-solid fa-align-left"></i>
                        <textarea id="serviceDescription" name="description" placeholder="Service Description (optional)" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn-auth">Update Service</button>
                </form>
            </div>
        </div>
        <div id="auth-check-message" style="display: none; text-align: center; padding: 40px;"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('agrohelp_token');
            const userRole = localStorage.getItem('agrohelp_user_role');
            const formContainer = document.getElementById('service-form-container');
            const authMessage = document.getElementById('auth-check-message');
            const form = document.getElementById('edit-service-form');

            const urlParams = new URLSearchParams(window.location.search);
            const serviceId = urlParams.get('id');

            if (!token || userRole !== 'expert') {
                formContainer.style.display = 'none';
                authMessage.style.display = 'block';
                authMessage.innerHTML = `<h2>Access Denied</h2><p>You must be logged in as a service provider to edit a service.</p><a href="auth_pro.html" class="cta-btn">Login as Provider</a>`;
                return;
            }

            if (!serviceId) {
                formContainer.style.display = 'none';
                authMessage.style.display = 'block';
                authMessage.innerHTML = `<h2>Error</h2><p>No service ID provided.</p><a href="dashboard.html" class="cta-btn">Go to Dashboard</a>`;
                return;
            }

            // Fetch existing service data
            try {
                const res = await fetch(`http://localhost:4000/api/products/${serviceId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const service = await res.json();

                if (!res.ok) throw new Error(service.error);

                // Populate the form
                document.getElementById('serviceName').value = service.name;
                document.getElementById('serviceCategory').value = service.category;
                document.getElementById('servicePrice').value = service.price;
                document.getElementById('serviceStock').value = service.stock;
                document.getElementById('serviceDescription').value = service.description || '';

            } catch (error) {
                formContainer.style.display = 'none';
                authMessage.style.display = 'block';
                authMessage.innerHTML = `<h2>Error</h2><p>Could not load service data: ${error.message}</p><a href="dashboard.html" class="cta-btn">Go to Dashboard</a>`;
            }

            // Handle form submission
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const updatedData = {
                    name: document.getElementById('serviceName').value,
                    category: document.getElementById('serviceCategory').value,
                    price: parseFloat(document.getElementById('servicePrice').value),
                    stock: parseInt(document.getElementById('serviceStock').value),
                    description: document.getElementById('serviceDescription').value
                };

                const response = await fetch(`http://localhost:4000/api/products/${serviceId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(updatedData)
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Service updated successfully!');
                    window.location.href = 'dashboard.html';
                } else {
                    alert(`Error: ${data.error || 'Failed to update service.'}`);
                }
            });
        });
    </script>
    <script src="navbar.js"></script>
</body>
</html>